<script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
            var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];

            // Convert sheet to JSON to filter blank rows
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
            // Filter out blank rows (rows where all cells are empty, null, or undefined)
            var filteredData = jsonData.filter(row => row.some(filledCell));

            // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
            var headerRowIndex = filteredData.findIndex((row, index) =>
              row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
            );
            // Fallback
            if (headerRowIndex === -1 || headerRowIndex > 25) {
              headerRowIndex = 0;
            }

            // Convert filtered JSON back to CSV
            var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
            csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
            return csv;
        } catch (e) {
            console.error(e);
            return "";
        }
    }
    return gk_fileData[filename] || "";
    }
</script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyalty Program Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        h2, h3 {
            color: #555;
            margin-bottom: 10px;
        }
        .dashboard-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .chart-row {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        .chart-container {
            flex: 1;
            min-width: 250px;
            max-width: 350px;
            text-align: center;
        }
        canvas {
            max-width: 100%;
            height: 200px;
            margin: 10px auto;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            padding: 5px 0;
            color: #666;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            color: #555;
        }
        button {
            padding: 8px 16px;
            background-color: #36A2EB;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1a8cd8;
        }
        input, textarea {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .status-message {
            margin-top: 10px;
            color: #333;
        }
        .form-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .form-row input, .form-row textarea {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }
        .form-row button {
            flex-shrink: 0;
        }
    </style>
</head>
<body>
<h1>Loyalty Program Dashboard</h1>

<!-- Key Metrics (Charts) -->
<div class="dashboard-section">
    <h2>Key Metrics</h2>
    <div class="chart-row">
        <!-- Churn Rate -->
        <div class="chart-container">
            <h3>Churn Rate (%)</h3>
            <p id="churn-rate">Loading...</p>
            <canvas id="churnChart"></canvas>
        </div>

        <!-- Repeat Purchase Rate -->
        <div class="chart-container">
            <h3>Repeat Purchase Rate (%)</h3>
            <p id="repeat-purchase-rate">Loading...</p>
            <canvas id="repeatPurchaseChart"></canvas>
        </div>

        <!-- Members -->
        <div class="chart-container">
            <h3>Members</h3>
            <p id="members-count">Loading...</p>
            <canvas id="membersChart"></canvas>
        </div>
    </div>
</div>

<!-- Active Members List -->
<div class="dashboard-section">
    <h2>Active Members</h2>
    <ul id="active-members"></ul>
</div>

<!-- Woopra Events -->
<div class="dashboard-section">
    <h2>Woopra Events (e.g., 'purchase')</h2>
    <ul id="woopra-events"></ul>
</div>

<!-- Transactions -->
<div class="dashboard-section">
    <h2>Transactions</h2>
    <div class="form-row">
        <input id="transaction-id" type="text" placeholder="Transaction ID">
        <input id="customer-id" type="text" placeholder="Customer ID">
        <input id="min-amount" type="number" placeholder="Min Amount">
        <input id="max-amount" type="number" placeholder="Max Amount">
        <button onclick="searchTransactions()">Find Transaction</button>
    </div>
    <table id="transactions-table">
        <thead>
        <tr>
            <th>Transaction ID</th>
            <th>Customer ID</th>
            <th>Amount</th>
            <th>Timestamp</th>
            <th>Items</th>
            <th>Coupon Used</th>
        </tr>
        </thead>
        <tbody id="transactions-body"></tbody>
    </table>
    <p id="transaction-status" class="status-message"></p>
</div>

<!-- Rewards -->
<div class="dashboard-section">
    <h2>Rewards</h2>
    <div class="form-row">
        <input id="search-reward-id" type="text" placeholder="Reward ID">
        <input id="search-reward-description" type="text" placeholder="Description">
        <button onclick="searchRewards()">Search Reward</button>
    </div>
    <div class="form-row" style="margin-top: 10px;">
        <input id="reward-id" type="text" placeholder="Reward ID">
        <textarea id="reward-description" placeholder="Reward Description"></textarea>
        <button onclick="addReward()">Add Reward</button>
    </div>
    <table id="rewards-table">
        <thead>
        <tr>
            <th>Reward ID</th>
            <th>Customer ID</th>
            <th>Points Earned</th>
            <th>Points Redeemed</th>
            <th>Date</th>
        </tr>
        </thead>
        <tbody id="rewards-body"></tbody>
    </table>
    <p id="reward-status" class="status-message"></p>
</div>

<!-- Reduce Churn -->
<div class="dashboard-section">
    <h2>Reduce Churn</h2>
    <button onclick="reduceChurn()">Reduce Churn Now</button>
    <p id="reduce-churn-status" class="status-message"></p>
</div>

<!-- Sync Customer -->
<div class="dashboard-section">
    <h2>Sync Customer</h2>
    <div class="form-row">
        <input id="sync-customer-id" type="text" placeholder="Customer ID">
        <input id="sync-customer-name" type="text" placeholder="Customer Name">
        <button onclick="syncCustomer()">Sync Customer</button>
    </div>
    <p id="customer-sync-status" class="status-message"></p>
</div>

<script>
    // Function to fetch and display Churn Rate
    async function fetchChurnRate() {
        try {
            const response = await fetch('/api/loyalty/churn-rate');
            if (!response.ok) throw new Error('Failed to fetch churn rate');
            const churnRate = await response.json();
            document.getElementById('churn-rate').innerText = churnRate.toFixed(2) + '%';

            const ctx = document.getElementById('churnChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Churn Rate'],
                    datasets: [{
                        label: 'Churn Rate (%)',
                        data: [churnRate],
                        backgroundColor: '#36A2EB',
                        borderColor: '#36A2EB',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 10 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            document.getElementById('churn-rate').innerText = 'Error fetching data';
        }
    }

    // Function to fetch and display Repeat Purchase Rate
    async function fetchRepeatPurchaseRate() {
        try {
            const response = await fetch('/api/loyalty/repeat-purchase-rate');
            if (!response.ok) throw new Error('Failed to fetch repeat purchase rate');
            const repeatRate = await response.json();
            document.getElementById('repeat-purchase-rate').innerText = repeatRate.toFixed(2) + '%';

            const ctx = document.getElementById('repeatPurchaseChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Repeat Purchase Rate'],
                    datasets: [{
                        label: 'Repeat Purchase Rate (%)',
                        data: [repeatRate],
                        backgroundColor: '#FF6384',
                        borderColor: '#FF6384',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 10 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            document.getElementById('repeat-purchase-rate').innerText = 'Error fetching data';
        }
    }

    // Function to fetch and display Members
    async function fetchMembers() {
        try {
            // Fetch Active Members
            const activeResponse = await fetch('/api/loyalty/active-members');
            if (!activeResponse.ok) throw new Error('Failed to fetch active members');
            const activeMembers = await activeResponse.json();

            // Display Active Members list
            const memberList = document.getElementById('active-members');
            activeMembers.forEach(member => {
                const li = document.createElement('li');
                li.innerText = `ID: ${member.id || 'undefined'}, Name: ${member.name || 'Unknown'}`;
                memberList.appendChild(li);
            });

            // Fetch Inactive Members
            const inactiveResponse = await fetch('/api/loyalty/inactive-members');
            if (!inactiveResponse.ok) throw new Error('Failed to fetch inactive members');
            const inactiveMembers = await inactiveResponse.json();

            // Calculate member counts
            const activeCount = activeMembers.length;
            const inactiveCount = inactiveMembers.length;
            document.getElementById('members-count').innerText = `Active: ${activeCount}, Inactive: ${inactiveCount}`;

            const ctx = document.getElementById('membersChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Members'],
                    datasets: [
                        {
                            label: 'Active Members',
                            data: [activeCount],
                            backgroundColor: '#4BC0C0',
                            borderColor: '#4BC0C0',
                            borderWidth: 1
                        },
                        {
                            label: 'Inactive Members',
                            data: [inactiveCount],
                            backgroundColor: '#FFCE56',
                            borderColor: '#FFCE56',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        } catch (error) {
            document.getElementById('members-count').innerText = 'Error fetching data';
        }
    }

    // Function to fetch and display Woopra Events
    async function fetchWoopraEvents() {
        try {
            const eventName = 'purchase';
            const response = await fetch(`/api/loyalty/woopra-events/${eventName}`);
            if (!response.ok) throw new Error(`Failed to fetch Woopra events: ${response.statusText} (${response.status})`);
            const events = await response.json();
            const eventList = document.getElementById('woopra-events');
            if (!events || events.length === 0) {
                eventList.innerHTML = '<li>No events found for "purchase". Try a different event name or ensure data exists.</li>';
                return;
            }
            events.forEach(event => {
                const li = document.createElement('li');
                li.innerText = `Event: ${event.eventName || 'Unknown'}, Timestamp: ${event.timestamp || 'N/A'}`;
                eventList.appendChild(li);
            });
        } catch (error) {
            console.error('Woopra Events Error:', error);
            document.getElementById('woopra-events').innerHTML = `<li>Error fetching data: ${error.message}</li>`;
        }
    }

    // Function to search Transactions
    async function searchTransactions() {
        try {
            const transactionId = document.getElementById('transaction-id').value;
            const customerId = document.getElementById('customer-id').value;
            const minAmount = document.getElementById('min-amount').value;
            const maxAmount = document.getElementById('max-amount').value;

            // Build query parameters
            const params = new URLSearchParams();
            if (transactionId) params.append('transactionId', transactionId);
            if (customerId) params.append('customerId', customerId);
            if (minAmount) params.append('minAmount', minAmount);
            if (maxAmount) params.append('maxAmount', maxAmount);

            const response = await fetch(`/api/loyalty/transactions?${params.toString()}`);
            if (!response.ok) throw new Error('Failed to fetch transactions');
            const transactions = await response.json();
            const tbody = document.getElementById('transactions-body');
            tbody.innerHTML = ''; // Clear existing rows
            if (transactions.length === 0) {
                document.getElementById('transaction-status').innerText = 'No transactions found.';
                return;
            }
            transactions.forEach(transaction => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${transaction.transactionId || 'N/A'}</td>
                    <td>${transaction.customerId || 'N/A'}</td>
                    <td>${transaction.amount ? transaction.amount.toFixed(2) : 'N/A'}</td>
                    <td>${transaction.timestamp || 'N/A'}</td>
                    <td>${transaction.items || 'N/A'}</td>
                    <td>${transaction.couponUsed !== undefined ? transaction.couponUsed : 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('transaction-status').innerText = '';
        } catch (error) {
            document.getElementById('transaction-status').innerText = 'Error fetching transactions: ' + error.message;
        }
    }

    // Function to search Rewards
    async function searchRewards() {
        try {
            const rewardId = document.getElementById('search-reward-id').value;
            const description = document.getElementById('search-reward-description').value;

            // Build query parameters
            const params = new URLSearchParams();
            if (rewardId) params.append('rewardId', rewardId);
            if (description) params.append('description', description);

            const response = await fetch(`/api/loyalty/rewards?${params.toString()}`);
            if (!response.ok) throw new Error('Failed to fetch rewards');
            const rewards = await response.json();
            const tbody = document.getElementById('rewards-body');
            tbody.innerHTML = ''; // Clear existing rows
            if (rewards.length === 0) {
                document.getElementById('reward-status').innerText = 'No rewards found.';
                return;
            }
            rewards.forEach(reward => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${reward.rewardId || 'N/A'}</td>
                    <td>${reward.customerId || 'N/A'}</td>
                    <td>${reward.pointsEarned || 'N/A'}</td>
                    <td>${reward.pointsRedeemed || 'N/A'}</td>
                    <td>${reward.date || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('reward-status').innerText = '';
        } catch (error) {
            document.getElementById('reward-status').innerText = 'Error fetching rewards: ' + error.message;
        }
    }

    // Function to add a Reward
    async function addReward() {
        try {
            const rewardId = document.getElementById('reward-id').value;
            const rewardDescription = document.getElementById('reward-description').value;
            if (!rewardId || !rewardDescription) throw new Error('Please fill in all fields');
            const reward = { id: rewardId, description: rewardDescription };

            const response = await fetch('/api/loyalty/rewards', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reward)
            });

            if (response.ok) {
                document.getElementById('reward-status').innerText = 'Reward added successfully!';
                document.getElementById('reward-id').value = '';
                document.getElementById('reward-description').value = '';
                searchRewards(); // Refresh the table
            } else {
                document.getElementById('reward-status').innerText = 'Failed to add reward.';
            }
        } catch (error) {
            document.getElementById('reward-status').innerText = 'Error: ' + error.message;
        }
    }

    // Function to trigger Reduce Churn
    async function reduceChurn() {
        try {
            const response = await fetch('/api/loyalty/reduce-churn', { method: 'POST' });
            if (response.ok) {
                document.getElementById('reduce-churn-status').innerText = 'Churn reduction triggered successfully!';
            } else {
                document.getElementById('reduce-churn-status').innerText = 'Failed to trigger churn reduction.';
            }
        } catch (error) {
            document.getElementById('reduce-churn-status').innerText = 'Error: ' + error.message;
        }
    }

    // Function to sync a Customer
    async function syncCustomer() {
        try {
            const customerId = document.getElementById('sync-customer-id').value;
            const customerName = document.getElementById('sync-customer-name').value;
            if (!customerId || !customerName) throw new Error('Please fill in all fields');
            const customer = { id: customerId, name: customerName };

            const response = await fetch('/api/loyalty/customers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(customer)
            });

            if (response.ok) {
                document.getElementById('customer-sync-status').innerText = 'Customer synced successfully!';
                document.getElementById('sync-customer-id').value = '';
                document.getElementById('sync-customer-name').value = '';
            } else {
                document.getElementById('customer-sync-status').innerText = 'Failed to sync customer.';
            }
        } catch (error) {
            document.getElementById('customer-sync-status').innerText = 'Error: ' + error.message;
        }
    }

    // Fetch all data on page load
    window.onload = () => {
        fetchChurnRate();
        fetchRepeatPurchaseRate();
        fetchMembers();
        fetchWoopraEvents();
        searchTransactions(); // Initial load of transactions
        searchRewards(); // Initial load of rewards
    };
</script>
</body>
</html>